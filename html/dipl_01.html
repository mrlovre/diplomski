
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Diplomski rad</title><meta name="generator" content="MATLAB 9.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-02-28"><meta name="DC.source" content="dipl_01.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Diplomski rad</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">U&#269;itavanje podataka</a></li><li><a href="#3">Testiranje nad parom dionica</a></li><li><a href="#4">Razliciti T-ovi</a></li><li><a href="#5">Najve&#263;a korelacija u nekom trenutku</a></li><li><a href="#6">Podskup podataka</a></li><li><a href="#7">Korelacije na podskupu</a></li><li><a href="#8">Simetri&#269;na matrica s jedinicama na dijagonali (nije potrebno)</a></li><li><a href="#9">Najbolji ostaju</a></li><li><a href="#10">Korelacije nad &#269;itavim skupom (puno br&#382;i algoritam)</a></li><li><a href="#11">Najbolji ostaju</a></li><li><a href="#12">Korelacije nad logaritmima cijene</a></li><li><a href="#13">Najbolji ostaju</a></li><li><a href="#14">Korelacije nad razlikama logaritama cijene</a></li><li><a href="#15">Najbolji ostaju</a></li><li><a href="#16">Minimizacija kvadrata razlike logaritma cijene</a></li><li><a href="#17">Najbolji ostaju</a></li><li><a href="#18">Prikaz akumuliranih kvadrata razlike logaritma cijene u jednom trenutku</a></li><li><a href="#19">Parovi s najmanjom razlikom</a></li><li><a href="#20">Dvije dionice koje se najdulje vrijeme najsli&#269;nije pona&#353;aju</a></li><li><a href="#21">Statisti&#269;ka arbitra&#382;a na tom intervalu</a></li></ul></div><pre class="codeinput">addpath <span class="string">functions</span>
</pre><h2 id="2">U&#269;itavanje podataka</h2><pre class="codeinput">sp500 = csvread(<span class="string">'data/stock_prices_sp500.csv'</span>);
sp500_returns = price2ret(sp500);
sp500_logprice = log(sp500);
sp500_logprice_diff = diff(sp500_logprice);
[days, N] = size(sp500);
graph_xy = [cos((1 : N) / N * 2 * pi).', sin((1 : N) / N * 2 * pi).'];
</pre><h2 id="3">Testiranje nad parom dionica</h2><pre class="codeinput">p1 = sp500(:, 1);
p2 = sp500(:, 2);
r1 = sp500_returns(:, 1);
r2 = sp500_returns(:, 2);

T = 250;

roll = rolling_corr(r1, r2, T);

figure, hold <span class="string">on</span>, yyaxis <span class="string">left</span>, plot(1 : days, p1, <span class="string">'b'</span>), plot(1 : days, p2, <span class="string">'b'</span>)
yyaxis <span class="string">right</span>, plot([nan(T - 1, 1); roll])
</pre><img vspace="5" hspace="5" src="dipl_01_01.png" alt=""> <h2 id="4">Razliciti T-ovi</h2><pre class="codeinput">figure, hold <span class="string">on</span>
<span class="keyword">for</span> T = [50, 150, 250, 500]
    roll = rolling_corr(r1, r2, T);
    plot([nan(T - 1, 1); roll])
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="dipl_01_02.png" alt=""> <h2 id="5">Najve&#263;a korelacija u nekom trenutku</h2><pre class="codeinput">T = 500;
t = 3124;
corrs = zeros(N, N);
sp500_returns_frame = sp500_returns(t : t + T - 1, :);
<span class="keyword">for</span> i = 1 : N
    <span class="keyword">for</span> j = i + 1 : N
        corrs(i, j) = corr(sp500_returns_frame(:, i), sp500_returns_frame(:, j));
        corrs(j, i) = corrs(i, j);
    <span class="keyword">end</span>
<span class="keyword">end</span>

imagesc(corrs)
colormap <span class="string">jet</span>
colorbar

clear <span class="string">sp500_returns_frame</span>
</pre><img vspace="5" hspace="5" src="dipl_01_03.png" alt=""> <h2 id="6">Podskup podataka</h2><pre class="codeinput">prices = sp500(1600 : 2500, :);
rets = price2ret(prices);
[L, ~] = size(rets);
T = 500;
</pre><h2 id="7">Korelacije na podskupu</h2><pre class="codeinput">corrs = nan(L - T + 1, N, N);

<span class="keyword">parfor</span> i = 1 : N
    fprintf(<span class="string">'\b.\n'</span>);
    corrs_t = nan(L - T + 1, N);
    <span class="keyword">for</span> j = i + 1 : N
        corrs_t(:, j) = rolling_corr(rets(:, i), rets(:, j), T);
    <span class="keyword">end</span>
    corrs(:, i, :) = corrs_t;
<span class="keyword">end</span>
</pre><h2 id="8">Simetri&#269;na matrica s jedinicama na dijagonali (nije potrebno)</h2><p>for i = 1 : N     corrs(:, i, i) = 1;     for j = i + 1 : N         corrs(:, j, i) = corrs(:, i, j);     end end</p><h2 id="9">Najbolji ostaju</h2><pre class="codeinput">nanmeans = nanmean(nanmean(permute(corrs, [3, 2, 1])));
counts = sum(sum(permute(corrs, [3, 2, 1]) &gt; 1.7 * nanmeans));
[bestI, bestJ] = find(permute(corrs, [3, 2, 1]) &gt; 1.7 * nanmeans);
</pre><h2 id="10">Korelacije nad &#269;itavim skupom (puno br&#382;i algoritam)</h2><pre class="codeinput">T = 500;
L = days - 1;
corrs = nan(L - T + 1, N, N);

fprintf([<span class="string">'\n'</span>, repmat(<span class="string">'.'</span>, 1, N), <span class="string">'\n\n'</span>]);
<span class="keyword">parfor</span> i = 1 : N
    corrs_t = nan(L - T + 1, N);
    <span class="keyword">for</span> j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_returns(:, i), sp500_returns(:, j), T);
    <span class="keyword">end</span>
    corrs(:, i, :) = corrs_t;
    fprintf(<span class="string">'\b#\n'</span>);
<span class="keyword">end</span>
</pre><pre class="codeoutput">
...........................................................................................................................................................................................................
###########################################################################################################################################################################################################
</pre><h2 id="11">Najbolji ostaju</h2><pre class="codeinput">nanmeans = nanmean(nanmean(permute(corrs, [3, 2, 1])));
maxes = max(max(permute(corrs, [3, 2, 1])));
counts = sum(sum(permute(corrs, [3, 2, 1]) &gt; nanmeans));

figure, hold <span class="string">on</span>
yyaxis <span class="string">left</span>, plot(nanmeans(:)), plot(maxes(:))
yyaxis <span class="string">right</span>, plot(counts(:))
legend <span class="string">means</span> <span class="string">maximums</span> <span class="string">counts</span> <span class="string">Location</span> <span class="string">best</span>

clear <span class="string">corrs</span>
</pre><img vspace="5" hspace="5" src="dipl_01_04.png" alt=""> <h2 id="12">Korelacije nad logaritmima cijene</h2><pre class="codeinput">T = 500;
L = days;
corrs_logprice = nan(L - T + 1, N, N);

fprintf([<span class="string">'\n'</span>, repmat(<span class="string">'.'</span>, 1, N), <span class="string">'\n\n'</span>]);
tic
<span class="keyword">parfor</span> i = 1 : N
    corrs_t = nan(L - T + 1, N);
    <span class="keyword">for</span> j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_logprice(:, i), sp500_logprice(:, j), T);
    <span class="keyword">end</span>
    corrs_logprice(:, i, :) = corrs_t;
    fprintf(<span class="string">'\b#\n'</span>);
<span class="keyword">end</span>
toc
</pre><pre class="codeoutput">
...........................................................................................................................................................................................................
###########################################################################################################################################################################################################
Elapsed time is 66.763646 seconds.
</pre><h2 id="13">Najbolji ostaju</h2><pre class="codeinput">nanmeans = nanmean(nanmean(permute(corrs_logprice, [3, 2, 1])));
maxes = max(max(permute(corrs_logprice, [3, 2, 1])));
counts = sum(sum(permute(corrs_logprice, [3, 2, 1]) &gt; nanmeans));

figure, hold <span class="string">on</span>
yyaxis <span class="string">left</span>, plot(nanmeans(:)), plot(maxes(:))
yyaxis <span class="string">right</span>, plot(counts(:))
legend <span class="string">means</span> <span class="string">maximums</span> <span class="string">counts</span> <span class="string">Location</span> <span class="string">best</span>

clear <span class="string">corrs_logprice</span>
</pre><img vspace="5" hspace="5" src="dipl_01_05.png" alt=""> <h2 id="14">Korelacije nad razlikama logaritama cijene</h2><pre class="codeinput">T = 500;
L = days - 1;
corrs_logprice_diff = nan(L - T + 1, N, N);

fprintf([<span class="string">'\n'</span>, repmat(<span class="string">'.'</span>, 1, N), <span class="string">'\n\n'</span>]);
tic
<span class="keyword">parfor</span> i = 1 : N
    corrs_t = nan(L - T + 1, N);
    <span class="keyword">for</span> j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_logprice_diff(:, i), sp500_logprice_diff(:, j), T);
    <span class="keyword">end</span>
    corrs_logprice_diff(:, i, :) = corrs_t;
    fprintf(<span class="string">'\b#\n'</span>);
<span class="keyword">end</span>
toc
</pre><pre class="codeoutput">
...........................................................................................................................................................................................................
###########################################################################################################################################################################################################
Elapsed time is 61.978078 seconds.
</pre><h2 id="15">Najbolji ostaju</h2><pre class="codeinput">nanmeans = nanmean(nanmean(permute(corrs_logprice_diff, [3, 2, 1])));
maxes = max(max(permute(corrs_logprice_diff, [3, 2, 1])));
counts = sum(sum(permute(corrs_logprice_diff, [3, 2, 1]) &gt; nanmeans));

figure, hold <span class="string">on</span>
yyaxis <span class="string">left</span>, plot(nanmeans(:)), plot(maxes(:))
yyaxis <span class="string">right</span>, plot(counts(:))
legend <span class="string">means</span> <span class="string">maximums</span> <span class="string">counts</span> <span class="string">Location</span> <span class="string">best</span>

clear <span class="string">corrs_logprice_diff</span>
</pre><img vspace="5" hspace="5" src="dipl_01_06.png" alt=""> <h2 id="16">Minimizacija kvadrata razlike logaritma cijene</h2><pre class="codeinput">T = 500;
L = days;
squared_logprice_diff = nan(L, N, N);

fprintf([<span class="string">'\n'</span>, repmat(<span class="string">'.'</span>, 1, N), <span class="string">'\n\n'</span>]);
tic
<span class="keyword">parfor</span> i = 1 : N
    squares_t = nan(L, N);
    <span class="keyword">for</span> j = i + 1 : N
        squares_t(:, j) = (sp500_logprice(:, i) - sp500_logprice(:, j)) .^ 2;
    <span class="keyword">end</span>
    squared_logprice_diff(:, i, :) = squares_t;
    fprintf(<span class="string">'\b#\n'</span>);
<span class="keyword">end</span>
toc

accum_squared_logprice_diff = movsum(squared_logprice_diff, T);
clear <span class="string">squared_logprice_diff</span>
</pre><pre class="codeoutput">
...........................................................................................................................................................................................................
###########################################################################################################################################################################################################
Elapsed time is 26.217057 seconds.
</pre><h2 id="17">Najbolji ostaju</h2><pre class="codeinput">nanmeans = nanmean(nanmean(permute(accum_squared_logprice_diff, [3, 2, 1])));
mins = min(min(permute(accum_squared_logprice_diff, [3, 2, 1])));
counts = sum(sum(permute(accum_squared_logprice_diff, [3, 2, 1]) &gt; nanmeans));

figure, hold <span class="string">on</span>
yyaxis <span class="string">left</span>, plot(nanmeans(:)), plot(mins(:))
yyaxis <span class="string">right</span>, plot(counts(:))
legend <span class="string">means</span> <span class="string">minimums</span> <span class="string">counts</span> <span class="string">Location</span> <span class="string">best</span>

figure, plot(mins(:))
legend <span class="string">minimums</span> <span class="string">Location</span> <span class="string">best</span>
</pre><img vspace="5" hspace="5" src="dipl_01_07.png" alt=""> <img vspace="5" hspace="5" src="dipl_01_08.png" alt=""> <h2 id="18">Prikaz akumuliranih kvadrata razlike logaritma cijene u jednom trenutku</h2><pre class="codeinput">figure, imagesc(squeeze(accum_squared_logprice_diff(4800, :, :)), [0, 10]), colormap <span class="string">jet</span>; colorbar
</pre><img vspace="5" hspace="5" src="dipl_01_09.png" alt=""> <h2 id="19">Parovi s najmanjom razlikom</h2><pre class="codeinput">[xs, ys] = argmin(accum_squared_logprice_diff);

<span class="comment">% Najmanja razlika koja najdulje traje je na intervalu 1700 - 2400 za par</span>
<span class="comment">% (190, 196).</span>
figure, yyaxis <span class="string">left</span>, plot(xs * 203 + ys), yyaxis <span class="string">right</span>, plot(mins(:))
</pre><img vspace="5" hspace="5" src="dipl_01_10.png" alt=""> <h2 id="20">Dvije dionice koje se najdulje vrijeme najsli&#269;nije pona&#353;aju</h2><pre class="codeinput">figure, hold <span class="string">on</span>, plot(sp500(1700 - T : 2400 - T, 190)), plot(sp500(1700 - T : 2400 - T, 196))
legend <span class="string">190</span> <span class="string">196</span>
</pre><img vspace="5" hspace="5" src="dipl_01_11.png" alt=""> <h2 id="21">Statisti&#269;ka arbitra&#382;a na tom intervalu</h2><pre class="codeinput">begin = 1700;
finish = 2400;
deltas = sp500_logprice(begin - T : finish, 190) - sp500_logprice(begin - T : finish, 196);
averages = movmean(deltas, T, <span class="string">'Endpoint'</span>, <span class="string">'discard'</span>);
stddevs = movstd(deltas, T, <span class="string">'Endpoint'</span>, <span class="string">'discard'</span>);

ds = [2, 1.8, 1.6, 1.3, 1];

<span class="keyword">for</span> d = ds
    decisions = zeros(finish - begin + 1, 1);
    profit = zeros(finish - begin + 1, 1);
    <span class="keyword">for</span> t = 1 : finish - begin
        <span class="keyword">if</span> deltas(t + T) &gt; averages(t) + d * stddevs(t)
            decisions(t) = 1;
            profit(t + 1) = profit(t) + deltas(t + T) - deltas(t + T + 1);
        <span class="keyword">elseif</span> deltas(t + T) &lt; averages(t) - d * stddevs(t)
            decisions(t) = -1;
            profit(t + 1) = profit(t) - deltas(t + T) + deltas(t + T + 1);
        <span class="keyword">else</span>
            profit(t + 1) = profit(t);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    figure, yyaxis <span class="string">left</span>, plot(decisions)
    yyaxis <span class="string">right</span>, plot(profit(2 : end))
    title(sprintf(<span class="string">'d=%.1f'</span>, d))
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="dipl_01_12.png" alt=""> <img vspace="5" hspace="5" src="dipl_01_13.png" alt=""> <img vspace="5" hspace="5" src="dipl_01_14.png" alt=""> <img vspace="5" hspace="5" src="dipl_01_15.png" alt=""> <img vspace="5" hspace="5" src="dipl_01_16.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Diplomski rad
%%

addpath functions

%% Učitavanje podataka
sp500 = csvread('data/stock_prices_sp500.csv');
sp500_returns = price2ret(sp500);
sp500_logprice = log(sp500);
sp500_logprice_diff = diff(sp500_logprice);
[days, N] = size(sp500);
graph_xy = [cos((1 : N) / N * 2 * pi).', sin((1 : N) / N * 2 * pi).'];

%% Testiranje nad parom dionica
p1 = sp500(:, 1);
p2 = sp500(:, 2);
r1 = sp500_returns(:, 1);
r2 = sp500_returns(:, 2);

T = 250;

roll = rolling_corr(r1, r2, T);

figure, hold on, yyaxis left, plot(1 : days, p1, 'b'), plot(1 : days, p2, 'b')
yyaxis right, plot([nan(T - 1, 1); roll])

%% Razliciti T-ovi
figure, hold on
for T = [50, 150, 250, 500]
    roll = rolling_corr(r1, r2, T);
    plot([nan(T - 1, 1); roll])
end

%% Najveća korelacija u nekom trenutku
T = 500;
t = 3124;
corrs = zeros(N, N);
sp500_returns_frame = sp500_returns(t : t + T - 1, :);
for i = 1 : N
    for j = i + 1 : N
        corrs(i, j) = corr(sp500_returns_frame(:, i), sp500_returns_frame(:, j));
        corrs(j, i) = corrs(i, j);
    end
end

imagesc(corrs)
colormap jet
colorbar

clear sp500_returns_frame

%% Podskup podataka
prices = sp500(1600 : 2500, :);
rets = price2ret(prices);
[L, ~] = size(rets);
T = 500;

%% Korelacije na podskupu
corrs = nan(L - T + 1, N, N);

parfor i = 1 : N
    fprintf('\b.\n');
    corrs_t = nan(L - T + 1, N);
    for j = i + 1 : N
        corrs_t(:, j) = rolling_corr(rets(:, i), rets(:, j), T);
    end
    corrs(:, i, :) = corrs_t;
end    

%% Simetrična matrica s jedinicama na dijagonali (nije potrebno)
% for i = 1 : N
%     corrs(:, i, i) = 1;
%     for j = i + 1 : N
%         corrs(:, j, i) = corrs(:, i, j);
%     end
% end

%% Najbolji ostaju
nanmeans = nanmean(nanmean(permute(corrs, [3, 2, 1])));
counts = sum(sum(permute(corrs, [3, 2, 1]) > 1.7 * nanmeans));
[bestI, bestJ] = find(permute(corrs, [3, 2, 1]) > 1.7 * nanmeans);

%% Korelacije nad čitavim skupom (puno brži algoritam)
T = 500;
L = days - 1;
corrs = nan(L - T + 1, N, N);

fprintf(['\n', repmat('.', 1, N), '\n\n']);
parfor i = 1 : N
    corrs_t = nan(L - T + 1, N);
    for j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_returns(:, i), sp500_returns(:, j), T);
    end
    corrs(:, i, :) = corrs_t;
    fprintf('\b#\n');
end

%% Najbolji ostaju
nanmeans = nanmean(nanmean(permute(corrs, [3, 2, 1])));
maxes = max(max(permute(corrs, [3, 2, 1])));
counts = sum(sum(permute(corrs, [3, 2, 1]) > nanmeans));

figure, hold on
yyaxis left, plot(nanmeans(:)), plot(maxes(:))
yyaxis right, plot(counts(:))
legend means maximums counts Location best

clear corrs

%% Korelacije nad logaritmima cijene
T = 500;
L = days;
corrs_logprice = nan(L - T + 1, N, N);

fprintf(['\n', repmat('.', 1, N), '\n\n']);
tic
parfor i = 1 : N
    corrs_t = nan(L - T + 1, N);
    for j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_logprice(:, i), sp500_logprice(:, j), T);
    end
    corrs_logprice(:, i, :) = corrs_t;
    fprintf('\b#\n');
end
toc

%% Najbolji ostaju
nanmeans = nanmean(nanmean(permute(corrs_logprice, [3, 2, 1])));
maxes = max(max(permute(corrs_logprice, [3, 2, 1])));
counts = sum(sum(permute(corrs_logprice, [3, 2, 1]) > nanmeans));

figure, hold on
yyaxis left, plot(nanmeans(:)), plot(maxes(:))
yyaxis right, plot(counts(:))
legend means maximums counts Location best

clear corrs_logprice

%% Korelacije nad razlikama logaritama cijene
T = 500;
L = days - 1;
corrs_logprice_diff = nan(L - T + 1, N, N);

fprintf(['\n', repmat('.', 1, N), '\n\n']);
tic
parfor i = 1 : N
    corrs_t = nan(L - T + 1, N);
    for j = i + 1 : N
        corrs_t(:, j) = rolling_corr(sp500_logprice_diff(:, i), sp500_logprice_diff(:, j), T);
    end
    corrs_logprice_diff(:, i, :) = corrs_t;
    fprintf('\b#\n');
end
toc

%% Najbolji ostaju
nanmeans = nanmean(nanmean(permute(corrs_logprice_diff, [3, 2, 1])));
maxes = max(max(permute(corrs_logprice_diff, [3, 2, 1])));
counts = sum(sum(permute(corrs_logprice_diff, [3, 2, 1]) > nanmeans));

figure, hold on
yyaxis left, plot(nanmeans(:)), plot(maxes(:))
yyaxis right, plot(counts(:))
legend means maximums counts Location best

clear corrs_logprice_diff

%% Minimizacija kvadrata razlike logaritma cijene
T = 500;
L = days;
squared_logprice_diff = nan(L, N, N);

fprintf(['\n', repmat('.', 1, N), '\n\n']);
tic
parfor i = 1 : N
    squares_t = nan(L, N);
    for j = i + 1 : N
        squares_t(:, j) = (sp500_logprice(:, i) - sp500_logprice(:, j)) .^ 2;
    end
    squared_logprice_diff(:, i, :) = squares_t;
    fprintf('\b#\n');
end
toc

accum_squared_logprice_diff = movsum(squared_logprice_diff, T);
clear squared_logprice_diff

%% Najbolji ostaju
nanmeans = nanmean(nanmean(permute(accum_squared_logprice_diff, [3, 2, 1])));
mins = min(min(permute(accum_squared_logprice_diff, [3, 2, 1])));
counts = sum(sum(permute(accum_squared_logprice_diff, [3, 2, 1]) > nanmeans));

figure, hold on
yyaxis left, plot(nanmeans(:)), plot(mins(:))
yyaxis right, plot(counts(:))
legend means minimums counts Location best

figure, plot(mins(:))
legend minimums Location best

%% Prikaz akumuliranih kvadrata razlike logaritma cijene u jednom trenutku
figure, imagesc(squeeze(accum_squared_logprice_diff(4800, :, :)), [0, 10]), colormap jet; colorbar

%% Parovi s najmanjom razlikom
[xs, ys] = argmin(accum_squared_logprice_diff);

% Najmanja razlika koja najdulje traje je na intervalu 1700 - 2400 za par
% (190, 196).
figure, yyaxis left, plot(xs * 203 + ys), yyaxis right, plot(mins(:))

%% Dvije dionice koje se najdulje vrijeme najsličnije ponašaju
figure, hold on, plot(sp500(1700 - T : 2400 - T, 190)), plot(sp500(1700 - T : 2400 - T, 196))
legend 190 196

%% Statistička arbitraža na tom intervalu
begin = 1700;
finish = 2400;
deltas = sp500_logprice(begin - T : finish, 190) - sp500_logprice(begin - T : finish, 196);
averages = movmean(deltas, T, 'Endpoint', 'discard');
stddevs = movstd(deltas, T, 'Endpoint', 'discard');

ds = [2, 1.8, 1.6, 1.3, 1];

for d = ds
    decisions = zeros(finish - begin + 1, 1);
    profit = zeros(finish - begin + 1, 1);
    for t = 1 : finish - begin 
        if deltas(t + T) > averages(t) + d * stddevs(t)
            decisions(t) = 1;
            profit(t + 1) = profit(t) + deltas(t + T) - deltas(t + T + 1);
        elseif deltas(t + T) < averages(t) - d * stddevs(t)
            decisions(t) = -1;
            profit(t + 1) = profit(t) - deltas(t + T) + deltas(t + T + 1);
        else
            profit(t + 1) = profit(t);
        end
    end
    figure, yyaxis left, plot(decisions)
    yyaxis right, plot(profit(2 : end))
    title(sprintf('d=%.1f', d))
end

##### SOURCE END #####
--></body></html>